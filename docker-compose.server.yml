version: '3.8'

services:
  deploypilot-agent:
    image: ghcr.io/stefankunde/deploypilot-user-agent:latest
    container_name: deploypilot-agent
    restart: always
    network_mode: host
    env_file:
      - .env
    environment:
      - BACKEND_URL=https://api.deploypilot.stefankunde.dev
      - LOG_LEVEL=info
      - POLL_INTERVAL_MS=10000
      - HEARTBEAT_INTERVAL_MS=30000
      - MAX_CONCURRENT_COMMANDS=3
      - PORT=3000
      - KUBECONFIG=/etc/rancher/k3s/k3s.yaml
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/rancher/k3s/k3s.yaml:/etc/rancher/k3s/k3s.yaml:ro
      - /etc/deploypilot.env:/etc/deploypilot.env:ro
      - /usr/local/bin/k3s:/usr/local/bin/k3s:ro
      - /run/k3s/containerd/containerd.sock:/run/k3s/containerd/containerd.sock
      - ./.env:/app/.env:ro
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
