version: '3.8'

services:
  deploypilot-agent:
    image: ghcr.io/stefankunde/deploypilot-user-agent:latest
    container_name: deploypilot-agent
    restart: always
    network_mode: host
    env_file:
      - .env
    environment:
      - BACKEND_URL=https://api.deploypilot.stefankunde.dev
      - LOG_LEVEL=info
      - POLL_INTERVAL_MS=10000
      - HEARTBEAT_INTERVAL_MS=30000
      - MAX_CONCURRENT_COMMANDS=3
      - PORT=3000
      - KUBECONFIG=/etc/rancher/k3s/k3s.yaml
    volumes:
      # K3s kubeconfig for kubectl access
      - /etc/rancher/k3s/k3s.yaml:/etc/rancher/k3s/k3s.yaml:ro
      # DeployPilot config (required by helper scripts)
      - /etc/deploypilot.env:/etc/deploypilot.env:ro
      # Helper scripts
      - /usr/local/bin/deploypilot-create-namespace:/usr/local/bin/deploypilot-create-namespace:ro
      - /usr/local/bin/deploypilot-deploy-app:/usr/local/bin/deploypilot-deploy-app:ro
      - /usr/local/bin/deploypilot-delete-app:/usr/local/bin/deploypilot-delete-app:ro
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
